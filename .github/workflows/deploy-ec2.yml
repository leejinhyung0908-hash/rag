name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'  # backend í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend  # ëª¨ë“  run ëª…ë ¹ì€ backend í´ë” ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        shell: bash
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # backend í´ë”ë¥¼ EC2ë¡œ ë™ê¸°í™”
          echo "ğŸš€ ë°°í¬ ì‹œì‘..."

          APP_DIR="$HOME/rag"
          BACKEND_DIR="$APP_DIR/backend"

          # rsyncë¡œ backend í´ë”ë§Œ ì „ì†¡
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no" \
            ./ \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:$BACKEND_DIR/

          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            APP_DIR="$HOME/rag"
            BACKEND_DIR="$APP_DIR/backend"

            echo "ğŸ“¥ backend í´ë” ë™ê¸°í™” ì™„ë£Œ"

            # Python ê°€ìƒí™˜ê²½ ì„¤ì •
            if [ ! -d "$APP_DIR/venv" ]; then
              echo "ğŸ Python ê°€ìƒí™˜ê²½ ìƒì„±..."
              python3 -m venv "$APP_DIR/venv"
            fi

            echo "ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜..."
            source "$APP_DIR/venv/bin/activate"
            pip install --upgrade pip
            cd "$BACKEND_DIR"
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f "$APP_DIR/.env" ]; then
              echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”."
            fi

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            if systemctl is-active --quiet rag-api.service 2>/dev/null; then
              echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
              sudo systemctl daemon-reload
              sudo systemctl restart rag-api.service
              echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"
            else
              echo "âš ï¸  rag-api.serviceê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "   scripts/rag-api.service íŒŒì¼ì„ /etc/systemd/system/ì— ë³µì‚¬í•´ì£¼ì„¸ìš”."
            fi

            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ: ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤."
            else
              echo "âš ï¸  ë°°í¬ ì™„ë£Œ: ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              echo "   ë¡œê·¸ í™•ì¸: sudo journalctl -u rag-api.service -n 50"
            fi
          ENDSSH

      - name: Health Check
        shell: bash
        run: |
          sleep 10
          if curl -f http://${{ secrets.EC2_HOST }}:8000/health > /dev/null 2>&1; then
            echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
          else
            echo "âš ï¸  ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ë³´ì•ˆ ê·¸ë£¹ì—ì„œ í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸)"
          fi || true
