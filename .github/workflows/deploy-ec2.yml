name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'  # backend í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    # working-directoryë¥¼ ì œê±°í•˜ê³  ëª…ì‹œì ìœ¼ë¡œ backend/ ê²½ë¡œë¥¼ ì‚¬ìš©
    # defaults:
    #   run:
    #     working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        shell: bash
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # backend í´ë”ë¥¼ EC2ë¡œ ë™ê¸°í™”
          echo "ğŸš€ ë°°í¬ ì‹œì‘..."

          # EC2 ê²½ë¡œ ì„¤ì • (EC2 ì„œë²„ì˜ ê²½ë¡œ - ëª…ì‹œì ìœ¼ë¡œ ì§€ì •)
          EC2_USER="${{ secrets.EC2_USER }}"
          EC2_HOST="${{ secrets.EC2_HOST }}"
          EC2_APP_DIR="/home/${EC2_USER}/rag"
          EC2_BACKEND_DIR="${EC2_APP_DIR}/backend"

          # EC2ì—ì„œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          echo "ğŸ“ EC2 ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘: ${EC2_BACKEND_DIR}"
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "mkdir -p ${EC2_BACKEND_DIR} && chmod 755 ${EC2_BACKEND_DIR}"

          # rsyncë¡œ backend í´ë”ë§Œ ì „ì†¡
          # working-directoryë¥¼ ì œê±°í–ˆìœ¼ë¯€ë¡œ, í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” ë¦¬í¬ì§€í† ë¦¬ ë£¨íŠ¸
          echo "ğŸ“¤ backend í´ë” ë™ê¸°í™” ì¤‘..."
          echo "   í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
          echo "   ì†ŒìŠ¤: backend/ (ëª…ì‹œì  ê²½ë¡œ)"
          echo "   ì†ŒìŠ¤ ë‚´ìš© (backend/ ë””ë ‰í† ë¦¬):"
          ls -la backend/ | head -10
          echo "   requirements.txt ì¡´ì¬ ì—¬ë¶€:"
          [ -f "backend/requirements.txt" ] && echo "   âœ… requirements.txt ì¡´ì¬" || echo "   âŒ requirements.txt ì—†ìŒ"
          echo "   ëŒ€ìƒ ê²½ë¡œ: ${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}/"

          # rsync: í˜„ì¬ ë””ë ‰í† ë¦¬(backend/)ì˜ ëª¨ë“  ë‚´ìš©ì„ EC2ì˜ ${EC2_BACKEND_DIR}/ë¡œ ë³µì‚¬
          # ì¤‘ìš”: rsyncì˜ ë™ì‘ ë°©ì‹
          # - rsync . target/  -> í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ë‚´ìš©ì„ target/ì— ë³µì‚¬ (ê¶Œì¥)
          # - rsync ./ target/ -> í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ ë‚´ìš©ì„ target/ì— ë³µì‚¬ (ë™ì¼)
          # - rsync . target   -> í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ targetì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë³µì‚¬ (ì˜ëª»ë¨)
          # ë”°ë¼ì„œ ëŒ€ìƒ ê²½ë¡œ ëì— ë°˜ë“œì‹œ / ë¥¼ ë¶™ì—¬ì•¼ í•¨
          echo "   rsync ì‹¤í–‰: $(pwd)/ -> ${EC2_BACKEND_DIR}/"
          echo "   í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "   ëŒ€ìƒ ê²½ë¡œ: ${EC2_BACKEND_DIR}/ (ëì— ìŠ¬ë˜ì‹œ ìˆìŒ)"
          echo "   ë³µì‚¬í•  íŒŒì¼ ëª©ë¡:"
          ls -la . | head -10

          # rsync ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
          # ì¤‘ìš”: working-directoryê°€ backendì´ë¯€ë¡œ í˜„ì¬ ë””ë ‰í† ë¦¬ëŠ” backend/
          # rsyncì˜ ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•:
          # - rsync source/ target/  -> sourceì˜ ë‚´ìš©ì„ targetì— ë³µì‚¬
          # - rsync source target/   -> sourceë¥¼ target ì•ˆì— ë³µì‚¬ (source ë””ë ‰í† ë¦¬ ìì²´ê°€ ë³µì‚¬ë¨)
          # ìš°ë¦¬ëŠ” backend/ì˜ ë‚´ìš©ì„ /home/ubuntu/rag/backend/ì— ë³µì‚¬í•´ì•¼ í•¨
          # ë”°ë¼ì„œ . ì„ ì‚¬ìš©í•˜ë©´ í˜„ì¬ ë””ë ‰í† ë¦¬(backend/)ì˜ ë‚´ìš©ì´ ë³µì‚¬ë¨
          REMOTE_TARGET="${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}"
          echo "   ìµœì¢… ëŒ€ìƒ ê²½ë¡œ: ${REMOTE_TARGET}"
          echo "   ì£¼ì˜: ëŒ€ìƒ ê²½ë¡œ ëì— / ì—†ìŒ (rsyncê°€ ë””ë ‰í† ë¦¬ ìì²´ë¥¼ ì²˜ë¦¬í•˜ë„ë¡)"

          # rsync ì‹¤í–‰ ì „ ê¸°ì¡´ backend ë””ë ‰í† ë¦¬ ì‚­ì œ (ê¹¨ë—í•œ ìƒíƒœë¡œ ì‹œì‘)
          echo "   ê¸°ì¡´ ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬ ì¤‘..."
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "rm -rf ${EC2_BACKEND_DIR}/* ${EC2_BACKEND_DIR}/.* 2>/dev/null || true"

          # rsync ì‹¤í–‰: backend/ í´ë”ì˜ ëª¨ë“  ë‚´ìš©ì„ EC2ì˜ ${EC2_BACKEND_DIR}/ë¡œ ë³µì‚¬
          # working-directoryë¥¼ ì œê±°í–ˆìœ¼ë¯€ë¡œ, ëª…ì‹œì ìœ¼ë¡œ backend/ ê²½ë¡œë¥¼ ì‚¬ìš©
          echo "   rsync ì‹¤í–‰ ì „ ìµœì¢… í™•ì¸:"
          echo "   - í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "   - ì†ŒìŠ¤: backend/ (ëª…ì‹œì  ê²½ë¡œ)"
          echo "   - ëŒ€ìƒ: ${REMOTE_TARGET}/"

          # rsync ì‹¤í–‰: backend/ í´ë”ì˜ ëª¨ë“  ë‚´ìš©ì„ ë³µì‚¬
          # backend/ ë¥¼ ì†ŒìŠ¤ë¡œ ì‚¬ìš©í•˜ë©´ backend/ì˜ ë‚´ìš©ì´ ë³µì‚¬ë¨
          if rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no" \
            --exclude='.git' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='.pytest_cache' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='venv' \
            --exclude='.venv' \
            --exclude='node_modules' \
            --exclude='.gitignore' \
            backend/ \
            "${REMOTE_TARGET}/"; then
            echo "âœ… rsync ì„±ê³µ"
          else
            echo "âŒ rsync ì‹¤íŒ¨"
            exit 1
          fi

          # rsync í›„ ì¦‰ì‹œ í™•ì¸
          echo "   rsync ì§í›„ í™•ì¸:"
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "echo 'BACKEND_DIR ë‚´ìš©:' && ls -la ${EC2_BACKEND_DIR}/ 2>&1 | head -10 && \
             echo 'requirements.txt ì¡´ì¬ ì—¬ë¶€:' && \
             ([ -f ${EC2_BACKEND_DIR}/requirements.txt ] && echo 'âœ… ì¡´ì¬' || echo 'âŒ ì—†ìŒ')"

          # rsync í›„ ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ” rsync í›„ ë””ë ‰í† ë¦¬ í™•ì¸..."
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "set -e && \
             echo '=== ë””ë ‰í† ë¦¬ í™•ì¸ ===' && \
             echo 'APP_DIR: ${EC2_APP_DIR}' && \
             echo 'BACKEND_DIR: ${EC2_BACKEND_DIR}' && \
             echo '' && \
             echo 'APP_DIR ì¡´ì¬ ì—¬ë¶€:' && [ -d ${EC2_APP_DIR} ] && echo 'âœ… ì¡´ì¬' || echo 'âŒ ì—†ìŒ' && \
             echo 'BACKEND_DIR ì¡´ì¬ ì—¬ë¶€:' && [ -d ${EC2_BACKEND_DIR} ] && echo 'âœ… ì¡´ì¬' || echo 'âŒ ì—†ìŒ' && \
             echo '' && \
             echo 'APP_DIR ë‚´ìš©:' && ls -la ${EC2_APP_DIR}/ 2>&1 | head -15 && \
             echo '' && \
             echo 'BACKEND_DIR ë‚´ìš©:' && ls -la ${EC2_BACKEND_DIR}/ 2>&1 | head -15 && \
             echo '' && \
             echo 'requirements.txt ìœ„ì¹˜ í™•ì¸:' && \
             if [ -f ${EC2_BACKEND_DIR}/requirements.txt ]; then \
               echo 'âœ… ${EC2_BACKEND_DIR}/requirements.txt ì¡´ì¬'; \
             else \
               echo 'âŒ ${EC2_BACKEND_DIR}/requirements.txt ì—†ìŒ'; \
               echo 'âš ï¸  íŒŒì¼ì´ ì˜ëª»ëœ ìœ„ì¹˜ì— ë³µì‚¬ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'; \
               if [ -f ${EC2_APP_DIR}/requirements.txt ]; then \
                 echo 'âš ï¸  ${EC2_APP_DIR}/requirements.txt ì¡´ì¬ (ì˜ëª»ëœ ìœ„ì¹˜!)'; \
                 echo 'âš ï¸  íŒŒì¼ì„ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ë¡œ ì´ë™í•©ë‹ˆë‹¤...'; \
                 mv ${EC2_APP_DIR}/requirements.txt ${EC2_BACKEND_DIR}/requirements.txt && \
                 echo 'âœ… íŒŒì¼ ì´ë™ ì™„ë£Œ'; \
               fi; \
             fi && \
             echo '' && \
             echo 'ìµœì¢… í™•ì¸: BACKEND_DIRì˜ requirements.txt' && \
             [ -f ${EC2_BACKEND_DIR}/requirements.txt ] && echo 'âœ… requirements.txtê°€ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤.' || echo 'âŒ requirements.txtê°€ ì—¬ì „íˆ ì—†ìŠµë‹ˆë‹¤.'"

          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          # heredocì—ì„œ ë³€ìˆ˜ í™•ì¥ì„ ìœ„í•´ ë”°ì˜´í‘œ ì—†ì´ ENDSSH ì‚¬ìš©
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} << ENDSSH
            set -e

            APP_DIR="\${HOME}/rag"
            BACKEND_DIR="\${APP_DIR}/backend"

            echo "ğŸ“¥ backend í´ë” ë™ê¸°í™” ì™„ë£Œ"
            echo "ğŸ” ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸..."
            echo "   HOME: \${HOME}"
            echo "   APP_DIR: \${APP_DIR}"
            echo "   BACKEND_DIR: \${BACKEND_DIR}"
            echo "   í˜„ì¬ ìœ„ì¹˜: \$(pwd)"

            # ë””ë ‰í† ë¦¬ í™•ì¸
            if [ -d "\${APP_DIR}" ]; then
              echo "âœ… APP_DIR ì¡´ì¬: \${APP_DIR}"
              echo "   ë‚´ìš©:"
              ls -la "\${APP_DIR}" | head -10
            else
              echo "âŒ APP_DIR ì—†ìŒ: \${APP_DIR}"
              echo "   ìƒì„± ì¤‘..."
              mkdir -p "\${APP_DIR}"
            fi

            if [ -d "\${BACKEND_DIR}" ]; then
              echo "âœ… BACKEND_DIR ì¡´ì¬: \${BACKEND_DIR}"
              echo "   ë‚´ìš©:"
              ls -la "\${BACKEND_DIR}" | head -15
            else
              echo "âŒ BACKEND_DIR ì—†ìŒ: \${BACKEND_DIR}"
              echo "   ìƒì„± ì¤‘..."
              mkdir -p "\${BACKEND_DIR}"
            fi

            # requirements.txtê°€ ì˜ëª»ëœ ìœ„ì¹˜ì— ìˆìœ¼ë©´ ì´ë™
            if [ ! -f "\${BACKEND_DIR}/requirements.txt" ] && [ -f "\${APP_DIR}/requirements.txt" ]; then
              echo "âš ï¸  requirements.txtê°€ ì˜ëª»ëœ ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤. ì´ë™ ì¤‘..."
              mv "\${APP_DIR}/requirements.txt" "\${BACKEND_DIR}/requirements.txt"
              echo "âœ… íŒŒì¼ ì´ë™ ì™„ë£Œ"
            fi

            # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
            echo "ğŸ“¦ í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
            if ! dpkg -l | grep -q python3-venv; then
              echo "ğŸ“¥ python3-venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi

            # Python ê°€ìƒí™˜ê²½ ì„¤ì •
            if [ ! -d "\${APP_DIR}/venv" ]; then
              echo "ğŸ Python ê°€ìƒí™˜ê²½ ìƒì„±..."
              python3 -m venv "\${APP_DIR}/venv"
            fi

            echo "ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜..."
            source "\${APP_DIR}/venv/bin/activate"
            pip install --upgrade pip

            # backend ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™: \${BACKEND_DIR}"
            if [ ! -d "\${BACKEND_DIR}" ]; then
              echo "âŒ ì˜¤ë¥˜: \${BACKEND_DIR} ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "   ìƒì„± ì¤‘..."
              mkdir -p "\${BACKEND_DIR}"
            fi

            # ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
            echo "ğŸ“‹ ë””ë ‰í† ë¦¬ ë‚´ìš© (ì´ë™ ì „):"
            ls -la "\${BACKEND_DIR}" || echo "ë””ë ‰í† ë¦¬ ì½ê¸° ì‹¤íŒ¨"

            cd "\${BACKEND_DIR}" || {
              echo "âŒ cd ì‹¤íŒ¨: \${BACKEND_DIR}"
              echo "   í˜„ì¬ ìœ„ì¹˜: \$(pwd)"
              exit 1
            }

            echo "âœ… í˜„ì¬ ë””ë ‰í† ë¦¬: \$(pwd)"
            echo "ğŸ“„ íŒŒì¼ ëª©ë¡:"
            ls -la

            # requirements.txt í™•ì¸ ë° ë³µêµ¬
            if [ ! -f "requirements.txt" ]; then
              echo "âŒ requirements.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
              echo "   ë””ë ‰í† ë¦¬ ë‚´ìš©:"
              ls -la
              echo "   ìƒìœ„ ë””ë ‰í† ë¦¬ í™•ì¸:"
              ls -la ..

              # ìƒìœ„ ë””ë ‰í† ë¦¬ì—ì„œ requirements.txt ì°¾ì•„ì„œ ì´ë™
              if [ -f "\${APP_DIR}/requirements.txt" ]; then
                echo "âš ï¸  ìƒìœ„ ë””ë ‰í† ë¦¬ì—ì„œ requirements.txt ë°œê²¬. ì´ë™ ì¤‘..."
                mv "\${APP_DIR}/requirements.txt" "\${BACKEND_DIR}/requirements.txt"
                echo "âœ… íŒŒì¼ ì´ë™ ì™„ë£Œ"
              else
                echo "âŒ requirements.txtë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
                exit 1
              fi
            fi

            echo "âœ… requirements.txt ë°œê²¬, ì˜ì¡´ì„± ì„¤ì¹˜ ì‹œì‘..."
            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f "\$APP_DIR/.env" ]; then
              echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”."
            fi

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            if systemctl is-active --quiet rag-api.service 2>/dev/null; then
              echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
              sudo systemctl daemon-reload
              sudo systemctl restart rag-api.service
              echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"
            else
              echo "âš ï¸  rag-api.serviceê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "   scripts/rag-api.service íŒŒì¼ì„ /etc/systemd/system/ì— ë³µì‚¬í•´ì£¼ì„¸ìš”."
            fi

            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ: ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤."
            else
              echo "âš ï¸  ë°°í¬ ì™„ë£Œ: ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              echo "   ë¡œê·¸ í™•ì¸: sudo journalctl -u rag-api.service -n 50"
            fi
          ENDSSH

      - name: Health Check
        shell: bash
        run: |
          sleep 10
          if curl -f http://${{ secrets.EC2_HOST }}:8000/health > /dev/null 2>&1; then
            echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
          else
            echo "âš ï¸  ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ë³´ì•ˆ ê·¸ë£¹ì—ì„œ í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸)"
          fi || true
