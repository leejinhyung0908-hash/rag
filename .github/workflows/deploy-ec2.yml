name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'  # backend 폴더 변경시에만 실행
  workflow_dispatch:  # 수동 실행 가능

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend  # 모든 run 명령은 backend 폴더 기준으로 실행

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        shell: bash
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # backend 폴더를 EC2로 동기화
          echo "🚀 배포 시작..."

          # EC2 경로 설정 (EC2 서버의 경로 - 명시적으로 지정)
          EC2_USER="${{ secrets.EC2_USER }}"
          EC2_HOST="${{ secrets.EC2_HOST }}"
          EC2_APP_DIR="/home/${EC2_USER}/rag"
          EC2_BACKEND_DIR="${EC2_APP_DIR}/backend"

          # EC2에서 디렉토리 미리 생성
          echo "📁 EC2 디렉토리 생성 중: ${EC2_BACKEND_DIR}"
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "mkdir -p ${EC2_BACKEND_DIR} && chmod 755 ${EC2_BACKEND_DIR}"

          # rsync로 backend 폴더만 전송
          echo "📤 backend 폴더 동기화 중..."
          echo "   소스: $(pwd)"
          echo "   소스 내용:"
          ls -la . | head -10
          echo "   대상 경로: ${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}/"

          # rsync 실행 및 결과 확인
          if rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no" \
            ./ \
            "${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}/"; then
            echo "✅ rsync 성공"
          else
            echo "❌ rsync 실패"
            exit 1
          fi

          # rsync 후 디렉토리 확인
          echo "🔍 rsync 후 디렉토리 확인..."
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "echo '디렉토리 존재 여부:' && [ -d ${EC2_BACKEND_DIR} ] && echo '✅ 존재' || echo '❌ 없음'; echo '디렉토리 내용:' && ls -la ${EC2_BACKEND_DIR}/ 2>&1 | head -10 || echo '읽기 실패'"

          # EC2에서 배포 스크립트 실행
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            set -e

            APP_DIR="\$HOME/rag"
            BACKEND_DIR="\$APP_DIR/backend"

            echo "📥 backend 폴더 동기화 완료"
            echo "🔍 디렉토리 구조 확인..."
            echo "   HOME: \$HOME"
            echo "   APP_DIR: \$APP_DIR"
            echo "   BACKEND_DIR: \$BACKEND_DIR"
            echo "   현재 위치: \$(pwd)"

            # 디렉토리 확인
            if [ -d "\$APP_DIR" ]; then
              echo "✅ APP_DIR 존재: \$APP_DIR"
              echo "   내용:"
              ls -la "\$APP_DIR" | head -10
            else
              echo "❌ APP_DIR 없음: \$APP_DIR"
              echo "   생성 중..."
              mkdir -p "\$APP_DIR"
            fi

            if [ -d "\$BACKEND_DIR" ]; then
              echo "✅ BACKEND_DIR 존재: \$BACKEND_DIR"
              echo "   내용:"
              ls -la "\$BACKEND_DIR" | head -15
            else
              echo "❌ BACKEND_DIR 없음: \$BACKEND_DIR"
              echo "   생성 중..."
              mkdir -p "\$BACKEND_DIR"
            fi

            # 필수 패키지 설치 확인
            echo "📦 필수 패키지 확인 중..."
            if ! dpkg -l | grep -q python3-venv; then
              echo "📥 python3-venv 패키지 설치 중..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi

            # Python 가상환경 설정
            if [ ! -d "\$APP_DIR/venv" ]; then
              echo "🐍 Python 가상환경 생성..."
              python3 -m venv "\$APP_DIR/venv"
            fi

            echo "📚 의존성 설치..."
            source "\$APP_DIR/venv/bin/activate"
            pip install --upgrade pip

            # backend 디렉토리로 이동
            echo "📂 작업 디렉토리로 이동: \$BACKEND_DIR"
            if [ ! -d "\$BACKEND_DIR" ]; then
              echo "❌ 오류: \$BACKEND_DIR 디렉토리가 존재하지 않습니다."
              echo "   생성 중..."
              mkdir -p "\$BACKEND_DIR"
            fi

            # 디렉토리 내용 확인
            echo "📋 디렉토리 내용 (이동 전):"
            ls -la "\$BACKEND_DIR" || echo "디렉토리 읽기 실패"

            cd "\$BACKEND_DIR" || {
              echo "❌ cd 실패: \$BACKEND_DIR"
              echo "   현재 위치: \$(pwd)"
              exit 1
            }

            echo "✅ 현재 디렉토리: \$(pwd)"
            echo "📄 파일 목록:"
            ls -la

            # requirements.txt 확인
            if [ ! -f "requirements.txt" ]; then
              echo "❌ requirements.txt 파일이 없습니다!"
              echo "   디렉토리 내용:"
              ls -la
              echo "   상위 디렉토리 확인:"
              ls -la ..
              exit 1
            fi

            echo "✅ requirements.txt 발견, 의존성 설치 시작..."
            pip install -r requirements.txt

            # 환경 변수 파일 확인
            if [ ! -f "\$APP_DIR/.env" ]; then
              echo "⚠️  .env 파일이 없습니다. 수동으로 생성해주세요."
            fi

            # systemd 서비스 재시작
            if systemctl is-active --quiet rag-api.service 2>/dev/null; then
              echo "🔄 서비스 재시작..."
              sudo systemctl daemon-reload
              sudo systemctl restart rag-api.service
              echo "✅ 서비스 재시작 완료"
            else
              echo "⚠️  rag-api.service가 설정되지 않았습니다."
              echo "   scripts/rag-api.service 파일을 /etc/systemd/system/에 복사해주세요."
            fi

            # 헬스 체크
            echo "🏥 헬스 체크..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "✅ 배포 성공: 서비스가 정상적으로 응답합니다."
            else
              echo "⚠️  배포 완료: 서비스 상태를 확인해주세요."
              echo "   로그 확인: sudo journalctl -u rag-api.service -n 50"
            fi
          ENDSSH

      - name: Health Check
        shell: bash
        run: |
          sleep 10
          if curl -f http://${{ secrets.EC2_HOST }}:8000/health > /dev/null 2>&1; then
            echo "✅ 외부 헬스 체크 성공"
          else
            echo "⚠️  외부 헬스 체크 실패 (보안 그룹에서 포트 8000이 열려있는지 확인)"
          fi || true
