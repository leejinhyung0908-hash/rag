name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'backend/**'  # backend í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend  # ëª¨ë“  run ëª…ë ¹ì€ backend í´ë” ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | tr -d '\r' > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        shell: bash
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          # backend í´ë”ë¥¼ EC2ë¡œ ë™ê¸°í™”
          echo "ğŸš€ ë°°í¬ ì‹œì‘..."

          # EC2 ê²½ë¡œ ì„¤ì • (EC2 ì„œë²„ì˜ ê²½ë¡œ - ëª…ì‹œì ìœ¼ë¡œ ì§€ì •)
          EC2_USER="${{ secrets.EC2_USER }}"
          EC2_HOST="${{ secrets.EC2_HOST }}"
          EC2_APP_DIR="/home/${EC2_USER}/rag"
          EC2_BACKEND_DIR="${EC2_APP_DIR}/backend"

          # EC2ì—ì„œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
          echo "ğŸ“ EC2 ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘: ${EC2_BACKEND_DIR}"
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "mkdir -p ${EC2_BACKEND_DIR} && chmod 755 ${EC2_BACKEND_DIR}"

          # rsyncë¡œ backend í´ë”ë§Œ ì „ì†¡
          echo "ğŸ“¤ backend í´ë” ë™ê¸°í™” ì¤‘..."
          echo "   ì†ŒìŠ¤: $(pwd)"
          echo "   ì†ŒìŠ¤ ë‚´ìš©:"
          ls -la . | head -10
          echo "   ëŒ€ìƒ ê²½ë¡œ: ${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}/"

          # rsync ì‹¤í–‰ ë° ê²°ê³¼ í™•ì¸
          if rsync -avz --delete \
            -e "ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no" \
            ./ \
            "${EC2_USER}@${EC2_HOST}:${EC2_BACKEND_DIR}/"; then
            echo "âœ… rsync ì„±ê³µ"
          else
            echo "âŒ rsync ì‹¤íŒ¨"
            exit 1
          fi

          # rsync í›„ ë””ë ‰í† ë¦¬ í™•ì¸
          echo "ğŸ” rsync í›„ ë””ë ‰í† ë¦¬ í™•ì¸..."
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${EC2_USER}@${EC2_HOST} \
            "echo 'ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€:' && [ -d ${EC2_BACKEND_DIR} ] && echo 'âœ… ì¡´ì¬' || echo 'âŒ ì—†ìŒ'; echo 'ë””ë ‰í† ë¦¬ ë‚´ìš©:' && ls -la ${EC2_BACKEND_DIR}/ 2>&1 | head -10 || echo 'ì½ê¸° ì‹¤íŒ¨'"

          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            APP_DIR="\$HOME/rag"
            BACKEND_DIR="\$APP_DIR/backend"

            echo "ğŸ“¥ backend í´ë” ë™ê¸°í™” ì™„ë£Œ"
            echo "ğŸ” ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸..."
            echo "   APP_DIR: \$APP_DIR"
            echo "   BACKEND_DIR: \$BACKEND_DIR"
            ls -la "\$APP_DIR" || echo "APP_DIRì´ ì—†ìŠµë‹ˆë‹¤"
            ls -la "\$BACKEND_DIR" || echo "BACKEND_DIRì´ ì—†ìŠµë‹ˆë‹¤"

            # í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ í™•ì¸
            echo "ğŸ“¦ í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
            if ! dpkg -l | grep -q python3-venv; then
              echo "ğŸ“¥ python3-venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi

            # Python ê°€ìƒí™˜ê²½ ì„¤ì •
            if [ ! -d "\$APP_DIR/venv" ]; then
              echo "ğŸ Python ê°€ìƒí™˜ê²½ ìƒì„±..."
              python3 -m venv "\$APP_DIR/venv"
            fi

            echo "ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜..."
            source "\$APP_DIR/venv/bin/activate"
            pip install --upgrade pip

            # backend ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì´ë™
            echo "ğŸ“‚ ì‘ì—… ë””ë ‰í† ë¦¬ í™•ì¸: \$BACKEND_DIR"
            if [ ! -d "\$BACKEND_DIR" ]; then
              echo "âŒ ì˜¤ë¥˜: \$BACKEND_DIR ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "   ìƒì„± ì¤‘..."
              mkdir -p "\$BACKEND_DIR"
              echo "   ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"
            fi

            # ë””ë ‰í† ë¦¬ ë‚´ìš© í™•ì¸
            echo "ğŸ“‹ ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -la "\$BACKEND_DIR" || echo "ë””ë ‰í† ë¦¬ ì½ê¸° ì‹¤íŒ¨"

            cd "\$BACKEND_DIR" || {
              echo "âŒ cd ì‹¤íŒ¨: \$BACKEND_DIR"
              echo "   í˜„ì¬ ìœ„ì¹˜: \$(pwd)"
              echo "   ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€: [ -d '\$BACKEND_DIR' ] && echo 'ì¡´ì¬' || echo 'ì—†ìŒ'"
              exit 1
            }
            echo "âœ… í˜„ì¬ ë””ë ‰í† ë¦¬: \$(pwd)"
            echo "ğŸ“„ requirements.txt í™•ì¸:"
            ls -la requirements.txt || echo "âš ï¸  requirements.txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"

            pip install -r requirements.txt

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f "\$APP_DIR/.env" ]; then
              echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”."
            fi

            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            if systemctl is-active --quiet rag-api.service 2>/dev/null; then
              echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
              sudo systemctl daemon-reload
              sudo systemctl restart rag-api.service
              echo "âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"
            else
              echo "âš ï¸  rag-api.serviceê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              echo "   scripts/rag-api.service íŒŒì¼ì„ /etc/systemd/system/ì— ë³µì‚¬í•´ì£¼ì„¸ìš”."
            fi

            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°°í¬ ì„±ê³µ: ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µí•©ë‹ˆë‹¤."
            else
              echo "âš ï¸  ë°°í¬ ì™„ë£Œ: ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
              echo "   ë¡œê·¸ í™•ì¸: sudo journalctl -u rag-api.service -n 50"
            fi
          ENDSSH

      - name: Health Check
        shell: bash
        run: |
          sleep 10
          if curl -f http://${{ secrets.EC2_HOST }}:8000/health > /dev/null 2>&1; then
            echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ"
          else
            echo "âš ï¸  ì™¸ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (ë³´ì•ˆ ê·¸ë£¹ì—ì„œ í¬íŠ¸ 8000ì´ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸)"
          fi || true
